<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Zeiterfassung Baustelle</title>

<style>
:root{
  --bg:#f6f7f9; --card:#fff; --text:#111827; --muted:#6b7280;
  --border:#e5e7eb; --shadow:0 10px 30px rgba(0,0,0,.07);
  --radius:18px; --btn-h:56px;
  --blue:#2563eb;
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--text)}
.wrap{max-width:520px;margin:0 auto;padding:16px}
.card{background:#fff;border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
h1{font-size:18px;margin:0}
.meta{color:var(--muted);font-size:13px;margin-top:6px}
.pill{display:inline-block;padding:8px 14px;border-radius:999px;font-weight:800;margin-top:12px}
.in{background:#dcfce7;color:#065f46}
.out{background:#fee2e2;color:#7f1d1d}
.pinRow{display:flex;gap:10px;justify-content:center;margin:14px 0}
.pinBox{width:52px;height:56px;border-radius:14px;border:1px solid var(--border);display:grid;place-items:center;font-size:22px;font-weight:900}
.keypad{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.key{height:54px;border-radius:16px;border:1px solid var(--border);background:#fff;font-size:18px;font-weight:800}
.row{display:flex;gap:10px;margin-top:12px}
button{height:var(--btn-h);border-radius:16px;border:0;font-size:16px;font-weight:800;cursor:pointer}
.primary{background:var(--blue);color:#fff}
.secondary{background:#fff;border:1px solid var(--border)}
.msg{margin-top:12px;padding:12px;border-radius:14px;font-size:13px}
.ok{background:#ecfdf5;border:1px solid #bbf7d0}
.err{background:#fef2f2;border:1px solid #fecaca}
.warn{background:#fffbeb;border:1px solid #fde68a}
.hidden{display:none}
footer{text-align:center;color:var(--muted);font-size:12px;margin-top:12px}
</style>
</head>

<body>
<div class="wrap">
  <div class="card">
    <h1>üèóÔ∏è Zeiterfassung</h1>
    <div id="siteInfo" class="meta">Lade Baustelle ‚Ä¶</div>
    <div id="dirPill" class="pill"></div>

    <div class="pinRow">
      <div class="pinBox" id="p0"></div>
      <div class="pinBox" id="p1"></div>
      <div class="pinBox" id="p2"></div>
      <div class="pinBox" id="p3"></div>
    </div>

    <div class="keypad">
      <button class="key" data-k="1">1</button>
      <button class="key" data-k="2">2</button>
      <button class="key" data-k="3">3</button>
      <button class="key" data-k="4">4</button>
      <button class="key" data-k="5">5</button>
      <button class="key" data-k="6">6</button>
      <button class="key" data-k="7">7</button>
      <button class="key" data-k="8">8</button>
      <button class="key" data-k="9">9</button>
      <button class="key" id="clear">C</button>
      <button class="key" data-k="0">0</button>
      <button class="key" id="back">‚å´</button>
    </div>

    <div class="row">
      <button class="secondary" id="forget">Code l√∂schen</button>
      <button class="primary" id="stamp" disabled>Jetzt stempeln</button>
    </div>

    <div id="msg" class="msg hidden"></div>
    <footer>GPS-Pr√ºfung aktiv ¬∑ Du musst an der Baustelle sein</footer>
  </div>
</div>

<script>
/* ===================== KONFIG ===================== */
const SPREADSHEET_ID = "1-nsAJvPlvxNTbdzVD5pj0O_J_DQWgALuYaTl9oFyU8c";
const GID = "0";
const STORAGE_KEY = "hf_employee_pin";

/* ===================== STATE ===================== */
let SITE_MAP = {};
let pin = "";
let siteId = null;
let dir = null;

/* ===================== HELPERS ===================== */
const $ = id => document.getElementById(id);

function showMsg(text,type){
  const el = $("msg");
  el.className = "msg " + type;
  el.textContent = text;
  el.classList.remove("hidden");
}

function updatePin(){
  for(let i=0;i<4;i++){
    $("p"+i).textContent = pin[i] ? "‚Ä¢" : "";
  }
  $("stamp").disabled = pin.length !== 4;
}

function haversine(lat1,lon1,lat2,lon2){
  const R=6371000;
  const dLat=(lat2-lat1)*Math.PI/180;
  const dLon=(lon2-lon1)*Math.PI/180;
  const a=Math.sin(dLat/2)**2+
    Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*
    Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

/* ===================== GVIZ -> MAP ===================== */
function gvizResponseToMap(resp){
  const cols = resp.table.cols.map(c => (c.label || "").trim());
  const rows = resp.table.rows;
  const idx = (name) => cols.indexOf(name);

  const toNum = (v) => Number(String(v ?? "").trim().replace(",", "."));

  const map = {};
  for(const r of rows){
    const c = r.c;
    const get = (name) => (c[idx(name)] ? c[idx(name)].v : "");

    const site = String(get("site_id") ?? "").trim();
    if(!site) continue;

    const active = String(get("active") ?? "1").trim();
    if(active !== "1") continue;

    map[site] = {
      name: String(get("name") ?? `Baustelle ${site}`),
      address: String(get("address") ?? ""),
      lat: toNum(get("lat")),
      lng: toNum(get("lng")),
      radius: toNum(get("radius_m")) || 0
    };
  }
  return map;
}

/* ===================== JSONP Loader (umgeht CORS) ===================== */
function loadSitesViaGvizJsonp(){
  return new Promise((resolve, reject) => {
    const cb = "__gviz_cb_" + Math.random().toString(36).slice(2);
    window[cb] = (resp) => {
      try{
        const map = gvizResponseToMap(resp);
        resolve(map);
      }catch(e){
        reject(e);
      }finally{
        delete window[cb];
        script.remove();
      }
    };

    // responseHandler ist der JSONP-Callback
    const tqx = encodeURIComponent(`out:json;responseHandler:${cb}`);
    const url = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?gid=${encodeURIComponent(GID)}&tqx=${tqx}`;

    const script = document.createElement("script");
    script.src = url;
    script.onerror = () => {
      delete window[cb];
      script.remove();
      reject(new Error("JSONP load failed"));
    };
    document.head.appendChild(script);
  });
}

/* ===================== INIT ===================== */
(async function init(){
  const url = new URL(location.href);
  siteId = url.searchParams.get("site");
  dir = url.searchParams.get("dir"); // "in" | "out"

  if(dir !== "in" && dir !== "out"){
    showMsg("‚ö†Ô∏è Bitte KOMMEN- oder GEHEN-QR scannen (dir=in|out fehlt).","warn");
    return;
  }
  if(!siteId){
    showMsg("‚ö†Ô∏è Baustellen-ID fehlt (site=...).","warn");
    return;
  }

  showMsg("‚è≥ Lade Baustellenliste ‚Ä¶","warn");

  try{
    SITE_MAP = await loadSitesViaGvizJsonp();
  }catch(e){
    showMsg("‚ùå Baustellenliste konnte nicht geladen werden (Sheet evtl. nicht freigegeben).","err");
    return;
  }

  showMsg(`‚ÑπÔ∏è Baustellen geladen: ${Object.keys(SITE_MAP).length}`,"warn");

  const s = SITE_MAP[String(siteId).trim()];
  if(!s){
    showMsg(`‚ùå Baustelle nicht gefunden (site=${siteId}). Pr√ºfe site_id im Sheet.`,"err");
    return;
  }

  $("siteInfo").innerHTML = `<b>${s.name}</b><br>${s.address}`;
  $("dirPill").textContent = dir==="in" ? "üü¢ KOMMEN" : "üî¥ GEHEN";
  $("dirPill").className = "pill " + (dir==="in" ? "in" : "out");

  const saved = localStorage.getItem(STORAGE_KEY);
  if(saved && /^\d{4}$/.test(saved)){
    pin = saved;
    updatePin();
    showMsg("‚ÑπÔ∏è Code vom Ger√§t geladen.","ok");
  }else{
    updatePin();
    showMsg("‚ÑπÔ∏è Bitte 4-stelligen Code eingeben.","warn");
  }
})();

/* ===================== EVENTS ===================== */
document.querySelectorAll("[data-k]").forEach(b=>{
  b.onclick=()=>{ if(pin.length<4){ pin+=b.dataset.k; updatePin(); } }
});
$("back").onclick=()=>{ pin=pin.slice(0,-1); updatePin(); };
$("clear").onclick=()=>{ pin=""; updatePin(); };
$("forget").onclick=()=>{ localStorage.removeItem(STORAGE_KEY); pin=""; updatePin(); showMsg("‚úÖ Code gel√∂scht.","ok"); };

$("stamp").onclick=()=>{
  const s = SITE_MAP[String(siteId).trim()];
  if(!s){ showMsg("‚ùå Baustelle nicht gefunden.","err"); return; }

  showMsg("üìç Standort wird gepr√ºft ‚Ä¶","warn");

  navigator.geolocation.getCurrentPosition(pos=>{
    const d = haversine(pos.coords.latitude,pos.coords.longitude,s.lat,s.lng);

    showMsg(`üìç Distanz ${Math.round(d)} m (Radius ${s.radius} m)`,"warn");

    if(d > s.radius){
      showMsg(`‚õî Zu weit weg (${Math.round(d)} m)`,"err");
      return;
    }

    localStorage.setItem(STORAGE_KEY,pin);
    showMsg(`‚úÖ ${dir==="in" ? "KOMMEN" : "GEHEN"} gespeichert`,"ok");

  },()=>{
    showMsg("‚õî GPS nicht erlaubt/fehlgeschlagen. Bitte Standort erlauben und neu versuchen.","err");
  },{enableHighAccuracy:true, timeout: 10000, maximumAge: 0});
};
</script>
</body>
</html>
