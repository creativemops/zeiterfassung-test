<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Zeiterfassung Baustelle</title>

<style>
:root{
  --bg:#f6f7f9; --card:#fff; --text:#111827; --muted:#6b7280;
  --border:#e5e7eb; --shadow:0 10px 30px rgba(0,0,0,.07);
  --radius:18px; --btn-h:56px; --blue:#2563eb;
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--text)}
.wrap{max-width:520px;margin:0 auto;padding:16px}
.card{background:#fff;border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
h1{font-size:18px;margin:0}
.meta{color:var(--muted);font-size:13px;margin-top:6px;line-height:1.35}
.pill{display:inline-block;padding:8px 14px;border-radius:999px;font-weight:800;margin-top:12px}
.in{background:#dcfce7;color:#065f46}
.out{background:#fee2e2;color:#7f1d1d}
.pinRow{display:flex;gap:10px;justify-content:center;margin:14px 0}
.pinBox{width:52px;height:56px;border-radius:14px;border:1px solid var(--border);display:grid;place-items:center;font-size:22px;font-weight:900}
.keypad{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.key{height:54px;border-radius:16px;border:1px solid var(--border);background:#fff;font-size:18px;font-weight:800}
.row{display:flex;gap:10px;margin-top:12px}
button{height:var(--btn-h);border-radius:16px;border:0;font-size:16px;font-weight:800;cursor:pointer}
.primary{background:var(--blue);color:#fff}
.secondary{background:#fff;border:1px solid var(--border)}
.msg{margin-top:12px;padding:12px;border-radius:14px;font-size:13px;line-height:1.35}
.ok{background:#ecfdf5;border:1px solid #bbf7d0}
.err{background:#fef2f2;border:1px solid #fecaca}
.warn{background:#fffbeb;border:1px solid #fde68a}
.hidden{display:none}
footer{text-align:center;color:var(--muted);font-size:12px;margin-top:12px}
</style>
</head>

<body>
<div class="wrap">
  <div class="card">
    <h1>üèóÔ∏è Zeiterfassung</h1>
    <div id="topStatus" class="meta">Status: Initialisiere ‚Ä¶</div>

    <div id="siteInfo" class="meta" style="margin-top:10px;">Lade Baustelle ‚Ä¶</div>
    <div id="dirPill" class="pill"></div>

    <div class="pinRow">
      <div class="pinBox" id="p0"></div>
      <div class="pinBox" id="p1"></div>
      <div class="pinBox" id="p2"></div>
      <div class="pinBox" id="p3"></div>
    </div>

    <div class="keypad">
      <button class="key" data-k="1">1</button>
      <button class="key" data-k="2">2</button>
      <button class="key" data-k="3">3</button>
      <button class="key" data-k="4">4</button>
      <button class="key" data-k="5">5</button>
      <button class="key" data-k="6">6</button>
      <button class="key" data-k="7">7</button>
      <button class="key" data-k="8">8</button>
      <button class="key" data-k="9">9</button>
      <button class="key" id="clear">C</button>
      <button class="key" data-k="0">0</button>
      <button class="key" id="back">‚å´</button>
    </div>

    <div class="row">
      <button class="secondary" id="forget">Code l√∂schen</button>
      <button class="primary" id="stamp" disabled>Jetzt stempeln</button>
    </div>

    <div id="msg" class="msg hidden"></div>
    <footer>GPS-Pr√ºfung aktiv ¬∑ Du musst an der Baustelle sein</footer>
  </div>
</div>

<script>
/* ===================== KONFIG ===================== */
// Baustellenliste (published CSV aus Google Sheet)
const PUBLISHED_ID = "2PACX-1vTuiGWgjdrDQBPaCXxysMOwGI5980QNzIV1Uopi4Mj1cUi2RBxXO5avvidzBUGoJNuY8mEjywSeS00F";
const GID = "0";
const PUBLISHED_CSV_URL = `https://docs.google.com/spreadsheets/d/e/${PUBLISHED_ID}/pub?gid=${encodeURIComponent(GID)}&single=true&output=csv`;

// Logging Endpoint (dein Apps Script)
const LOG_ENDPOINT_URL = "https://script.google.com/macros/s/AKfycbyme0qOs30XbDl-OCudxsd0DTvX4RTZKQSkIu55edZD0FT3plb8zw4Wo9ZnQDEqVKFO/exec";

// !!! Token muss identisch im Apps Script stehen !!!
const LOG_TOKEN = "CHANGE_ME_SECRET";

// Local Storage Keys
const STORAGE_PIN = "hf_employee_pin";
const STORAGE_DEVICE = "hf_device_id";

/* ===================== STATE ===================== */
let SITE_MAP = {};
let pin = "";
let siteId = null;
let dir = null;

/* ===================== HELPERS ===================== */
const $ = id => document.getElementById(id);
function setTop(t){ $("topStatus").textContent = "Status: " + t; }

function showMsg(text,type){
  const el = $("msg");
  el.className = "msg " + type;
  el.textContent = text;
  el.classList.remove("hidden");
}

function updatePin(){
  for(let i=0;i<4;i++) $("p"+i).textContent = pin[i] ? "‚Ä¢" : "";
  $("stamp").disabled = pin.length !== 4;
}

function getOrCreateDeviceId(){
  let id = localStorage.getItem(STORAGE_DEVICE);
  if(id && id.length > 10) return id;
  id = "dev_" + Math.random().toString(36).slice(2) + "_" + Date.now().toString(36);
  localStorage.setItem(STORAGE_DEVICE, id);
  return id;
}

function haversine(lat1,lon1,lat2,lon2){
  const R=6371000;
  const dLat=(lat2-lat1)*Math.PI/180;
  const dLon=(lon2-lon1)*Math.PI/180;
  const a=Math.sin(dLat/2)**2+
    Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*
    Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

function detectDelimiter(headerLine){
  if(headerLine.includes(";")) return ";";
  if(headerLine.includes(",")) return ",";
  return ",";
}

function splitCsvLine(line, delim){
  const out = [];
  let cur = "";
  let inQ = false;
  for(let i=0;i<line.length;i++){
    const ch = line[i];
    if(ch === '"'){
      if(inQ && line[i+1] === '"'){ cur += '"'; i++; }
      else inQ = !inQ;
    } else if(ch === delim && !inQ){
      out.push(cur); cur = "";
    } else {
      cur += ch;
    }
  }
  out.push(cur);
  return out.map(s => s.trim());
}

function csvToMap(csvText){
  const lines = csvText.replace(/\r/g,"").split("\n").filter(l => l.trim().length);
  if(lines.length < 2) return {};

  const delim = detectDelimiter(lines[0]);
  const headers = splitCsvLine(lines[0], delim).map(h => h.trim());
  const idx = (name) => headers.indexOf(name);
  const toNum = (v) => Number(String(v ?? "").trim().replace(",", "."));

  const map = {};
  for(let r=1;r<lines.length;r++){
    const cols = splitCsvLine(lines[r], delim);

    const site = String(cols[idx("site_id")] ?? "").trim();
    if(!site) continue;

    const active = String(cols[idx("active")] ?? "1").trim();
    if(active !== "1") continue;

    map[site] = {
      name: String(cols[idx("name")] ?? `Baustelle ${site}`),
      address: String(cols[idx("address")] ?? ""),
      lat: toNum(cols[idx("lat")]),
      lng: toNum(cols[idx("lng")]),
      radius: toNum(cols[idx("radius_m")]) || 0
    };
  }
  return map;
}

async function fetchWithTimeout(url, ms=12000){
  const ctrl = new AbortController();
  const t = setTimeout(()=>ctrl.abort(), ms);
  try{
    const r = await fetch(url, { cache:"no-store", signal: ctrl.signal });
    if(!r.ok) throw new Error("HTTP " + r.status);
    return await r.text();
  } finally {
    clearTimeout(t);
  }
}

async function postJson(url, payload, ms=12000){
  const ctrl = new AbortController();
  const t = setTimeout(()=>ctrl.abort(), ms);
  try{
    const r = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
      signal: ctrl.signal
    });
    const text = await r.text();
    // Apps Script antwortet oft mit JSON-Text, aber wir sind tolerant
    try { return JSON.parse(text); } catch { return { ok: r.ok, raw: text }; }
  } finally {
    clearTimeout(t);
  }
}

/* ===================== INIT ===================== */
(async function init(){
  const url = new URL(location.href);
  siteId = url.searchParams.get("site");
  dir = url.searchParams.get("dir");

  if(dir !== "in" && dir !== "out"){
    setTop("Fehler: dir fehlt");
    showMsg("‚ö†Ô∏è Bitte KOMMEN- oder GEHEN-QR scannen (dir=in|out fehlt).","warn");
    return;
  }
  if(!siteId){
    setTop("Fehler: site fehlt");
    showMsg("‚ö†Ô∏è Baustellen-ID fehlt (site=...).","warn");
    return;
  }

  setTop("Lade Baustellenliste ‚Ä¶");
  $("siteInfo").textContent = "Lade Baustelle ‚Ä¶";

  try{
    const csv = await fetchWithTimeout(PUBLISHED_CSV_URL, 12000);
    SITE_MAP = csvToMap(csv);
  }catch(e){
    setTop("Fehler beim Laden");
    showMsg("‚ùå Baustellenliste konnte nicht geladen werden.","err");
    return;
  }

  setTop(`Baustellen geladen: ${Object.keys(SITE_MAP).length}`);
  showMsg(`‚ÑπÔ∏è Baustellen geladen: ${Object.keys(SITE_MAP).length}`,"ok");

  const s = SITE_MAP[String(siteId).trim()];
  if(!s){
    showMsg(`‚ùå Baustelle nicht gefunden (site=${siteId}). Pr√ºfe site_id im Sheet.`,"err");
    return;
  }

  $("siteInfo").innerHTML = `<b>${s.name}</b><br>${s.address}`;
  $("dirPill").textContent = dir==="in" ? "üü¢ KOMMEN" : "üî¥ GEHEN";
  $("dirPill").className = "pill " + (dir==="in" ? "in" : "out");

  const saved = localStorage.getItem(STORAGE_PIN);
  if(saved && /^\d{4}$/.test(saved)){
    pin = saved;
    updatePin();
    showMsg("‚ÑπÔ∏è Code vom Ger√§t geladen.","ok");
  }else{
    updatePin();
    showMsg("‚ÑπÔ∏è Bitte 4-stelligen Code eingeben.","warn");
  }
})();

/* ===================== EVENTS ===================== */
document.querySelectorAll("[data-k]").forEach(b=>{
  b.onclick=()=>{ if(pin.length<4){ pin+=b.dataset.k; updatePin(); } }
});
$("back").onclick=()=>{ pin=pin.slice(0,-1); updatePin(); };
$("clear").onclick=()=>{ pin=""; updatePin(); };
$("forget").onclick=()=>{ localStorage.removeItem(STORAGE_PIN); pin=""; updatePin(); showMsg("‚úÖ Code gel√∂scht.","ok"); };

$("stamp").onclick=()=>{
  const s = SITE_MAP[String(siteId).trim()];
  if(!s){ showMsg("‚ùå Baustelle nicht gefunden.","err"); return; }

  showMsg("üìç Standort wird gepr√ºft ‚Ä¶","warn");

  navigator.geolocation.getCurrentPosition(async pos=>{
    const d = haversine(pos.coords.latitude,pos.coords.longitude,s.lat,s.lng);

    showMsg(`üìç Distanz ${Math.round(d)} m (Radius ${s.radius} m)`,"warn");

    if(d > s.radius){
      showMsg(`‚õî Zu weit weg (${Math.round(d)} m)`,"err");
      return;
    }

    // Device + PIN merken
    const deviceId = getOrCreateDeviceId();
    localStorage.setItem(STORAGE_PIN, pin);

    // Logging Payload
    const payload = {
      token: LOG_TOKEN,
      site_id: String(siteId).trim(),
      direction: dir,
      employee_code: pin,
      device_id: deviceId,
      lat: pos.coords.latitude,
      lng: pos.coords.longitude,
      distance_m: Math.round(d),
      user_agent: navigator.userAgent
    };

    showMsg("‚òÅÔ∏è Sende Stempelung ‚Ä¶","warn");

    try{
      const res = await postJson(LOG_ENDPOINT_URL, payload, 12000);
      if(res && res.ok){
        showMsg(`‚úÖ ${dir==="in" ? "KOMMEN" : "GEHEN"} gespeichert (Log ok)`,"ok");
      }else{
        showMsg("‚ö†Ô∏è Stempelung lokal ok, aber Log fehlgeschlagen. Bitte erneut versuchen.","warn");
      }
    }catch(e){
      showMsg("‚ö†Ô∏è Stempelung lokal ok, aber Log fehlgeschlagen (Netz). Bitte erneut versuchen.","warn");
    }

  },()=>{
    showMsg("‚õî GPS nicht erlaubt/fehlgeschlagen. Bitte Standort erlauben und neu versuchen.","err");
  },{enableHighAccuracy:true, timeout: 10000, maximumAge: 0});
};
</script>
</body>
</html>
